CREATE OR REPLACE PROCEDURE PCFINALIZA_OS(PCOD_TERMINAL            VARCHAR2,
                                          PCOD_APLICACAO           VARCHAR2,
                                          PCOD_EMPRESA             NUMBER,
                                          PCOD_CLIENTE             NUMBER,
                                          PCOD_OS                  NUMBER,
                                          PDESCRICAO_OS            VARCHAR2,
                                          PDATA_INICIO             DATE,
                                          PDATA_PREVISAO_FIM       DATE,
                                          PVALOR_TOTAL             NUMBER,
                                          PVALOR_DESCONTO          NUMBER,
                                          PUSUA_RESPONSAVEL        VARCHAR2,
                                          PMOTIVO_DESCONTO         VARCHAR2,
                                          PCOD_USUARIO_RESPONSAVEL NUMBER,
                                          PCOD_ORCAMENTO_RELAC     NUMBER) IS
   IVLR_SERV_TERCEIRO         TBSERVICOS2.VALOR%TYPE;
   IQTDE_SERV_TERCEIRO        NUMBER;
   ICOD_SERV_TERCEIRO         TBSERVICOS2.COD_SERVICO_TERCEIRO%TYPE;
   SRAZAO_SOCIAL              TBCLIENTE.NOME_NOME_FANTASIA%TYPE;
   STEM_ORCAMENTO_RELACIONADO VARCHAR2(1);

BEGIN
   STEM_ORCAMENTO_RELACIONADO := 'N';
   IF PCOD_ORCAMENTO_RELAC > 0 THEN
      STEM_ORCAMENTO_RELACIONADO := 'S';
   END IF;

   SELECT A.NOME_NOME_FANTASIA
   INTO SRAZAO_SOCIAL
   FROM TBCLIENTE A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.COD_CLIENTE = PCOD_CLIENTE;

   UPDATE TBHEADERORDEM_SERVICO A
   SET A.OBSERVACOES              = PDESCRICAO_OS,
       A.DATA_INICIO              = PDATA_INICIO,
       A.DATA_PREVISAO_FIM        = PDATA_PREVISAO_FIM,
       A.VALOR_TOTAL              = PVALOR_TOTAL,
       A.VALOR_DESCONTO           = PVALOR_DESCONTO,
       A.USUARIO_EXE              = PUSUA_RESPONSAVEL,
       A.MOTIVO_DESCONTO          = PMOTIVO_DESCONTO,
       COD_USUARIO_RESPONSAVEL    = PCOD_USUARIO_RESPONSAVEL,
       NOME_NOME_FANTASIA_CLIENTE = SRAZAO_SOCIAL,
       TEM_ORCAMENTO_RELACIONADO  = STEM_ORCAMENTO_RELACIONADO,
       COD_ORCAMENTO_RELAC        = PCOD_ORCAMENTO_RELAC
   WHERE A.COD_OS = PCOD_OS AND
         A.COD_EMPRESA = PCOD_EMPRESA AND
         A.COD_CLIENTE = PCOD_CLIENTE;
   IF SQL%NOTFOUND THEN
      INSERT INTO TBHEADERORDEM_SERVICO
         (COD_OS, COD_EMPRESA, COD_CLIENTE, OBSERVACOES, SITUACAO, DATA_INICIO, DATA_PREVISAO_FIM,
          VALOR_TOTAL, VALOR_DESCONTO, USUARIO_EXE, MOTIVO_DESCONTO, COD_USUARIO_RESPONSAVEL,
          NOME_NOME_FANTASIA_CLIENTE, TEM_ORCAMENTO_RELACIONADO, COD_ORCAMENTO_RELAC)
      VALUES
         (PCOD_OS, PCOD_EMPRESA, PCOD_CLIENTE, PDESCRICAO_OS, 'A', PDATA_INICIO, PDATA_PREVISAO_FIM,
          PVALOR_TOTAL, PVALOR_DESCONTO, PUSUA_RESPONSAVEL, PMOTIVO_DESCONTO, PCOD_USUARIO_RESPONSAVEL,
          SRAZAO_SOCIAL, STEM_ORCAMENTO_RELACIONADO, PCOD_ORCAMENTO_RELAC);
   END IF;

   DELETE FROM TBHEADERITENS_OS
   WHERE COD_OS = PCOD_OS AND
         COD_EMPRESA = PCOD_EMPRESA AND
         COD_CLIENTE = PCOD_CLIENTE;

   FOR VITENS IN (SELECT *
                  FROM TBTEMPORARIA A
                  WHERE A.CODTERMINAL = PCOD_TERMINAL AND
                        A.COD_APLICACAO = PCOD_APLICACAO AND
                        A.NUM1 = PCOD_EMPRESA AND
                        A.TIPOREGISTRO = 'T')
   LOOP
      --/// deleto da Itens para inserir somente os itens que estavam na tela do cara
   
      UPDATE TBHEADERITENS_OS B
      SET B.VALOR_SERV_INDIVIDUAL = VITENS.NUM4,
          B.QUANTIDADE_SERVICO    = VITENS.NUM5
      WHERE B.COD_SERVICO = VITENS.NUM3 AND
            B.COD_OS = PCOD_OS AND
            B.COD_EMPRESA = PCOD_EMPRESA AND
            B.COD_CLIENTE = PCOD_CLIENTE;
      IF SQL%NOTFOUND THEN
         INSERT INTO TBHEADERITENS_OS
            (COD_SERVICO, COD_OS, COD_EMPRESA, COD_CLIENTE, VALOR_SERV_INDIVIDUAL, QUANTIDADE_SERVICO)
         VALUES
            (VITENS.NUM3, PCOD_OS, PCOD_EMPRESA, PCOD_CLIENTE, VITENS.NUM4, VITENS.NUM5);
      END IF;
   END LOOP;
--- inativo o orçamento
   IF NVL(PCOD_ORCAMENTO_RELAC, 0) > 0 THEN
      UPDATE TBHEADER_ORCAMENTO H
      SET H.SITUACAO = 'I'
      WHERE H.COD_ORCAMENTO = PCOD_ORCAMENTO_RELAC AND
            H.COD_EMPRESA = PCOD_EMPRESA AND
            H.COD_CLIENTE = PCOD_CLIENTE;
   END IF;
END;
/
