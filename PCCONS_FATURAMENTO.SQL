CREATE OR REPLACE PROCEDURE PCCONS_FATURAMENTO(PCOD_TERMINAL  VARCHAR2,
                                               PCOD_APLICACAO VARCHAR2,
                                               PCOD_EMPRESA   VARCHAR2,
                                               PDATA_INICIAL  DATE,
                                               PDATA_FINAL    DATE) IS

   IVLR_DESPESAS_PAGAS    NUMBER;
   IVLR_DESPESAS          NUMBER;
   IVLR_DESPESAS_VENCIDAS NUMBER; -- NÃO PAGAS
   IVLR_REAL_A_PAGAR      NUMBER;
   IVLR_RECEBIDO          NUMBER; ---
   IVLR_RECEBER_VENCIDO   NUMBER;
   IVLR_RECEBER_REAL      NUMBER;
   IVLR_LUCRO             NUMBER;
   IVLR_LUCRO_ESTIMADO    NUMBER;
   IVLR_A_RECEBER         NUMBER;
BEGIN
   IVLR_DESPESAS_PAGAS    := 0;
   IVLR_DESPESAS_VENCIDAS := 0;
   IVLR_RECEBIDO          := 0;
   IVLR_RECEBER_VENCIDO   := 0;
   IVLR_LUCRO             := 0;
   IVLR_LUCRO_ESTIMADO    := 0;
   IVLR_REAL_A_PAGAR      := 0;
   IVLR_RECEBER_REAL      := 0;
   IVLR_DESPESAS          := 0;
   IVLR_A_RECEBER         := 0;

   DELETE FROM TBTEMPORARIA A
   WHERE A.CODTERMINAL = PCOD_TERMINAL AND
         A.COD_APLICACAO = PCOD_APLICACAO;


   -- DESPESAS(SAIDA) ----
   -- AQUI PEGO O VALOR PAGO 
   SELECT NVL(SUM(NVL(A.VALOR_REAL_PAGO, A.VALOR_DESPESA)), 0)
   INTO IVLR_DESPESAS_PAGAS
   FROM TBCONTAS_PAGAR A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.SITUACAO = 'P' AND -- PAGAS
         TRUNC(A.DATA_PAGAMENTO) >= PDATA_INICIAL AND
         TRUNC(A.DATA_PAGAMENTO) <= PDATA_FINAL;

   -- AQUI PEGO O VALOR DAS PARCELAS , MAS NAO SIGNIFICA QUE É O VALOR REAL PAGO
   SELECT NVL(SUM(A.VALOR_DESPESA), 0)
   INTO IVLR_DESPESAS
   FROM TBCONTAS_PAGAR A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.SITUACAO = 'P' AND -- PAGAS
         TRUNC(A.DATA_PAGAMENTO) >= PDATA_INICIAL AND
         TRUNC(A.DATA_PAGAMENTO) <= PDATA_FINAL;


   SELECT NVL(SUM(NVL(A.VALOR_REAL_PAGO, A.VALOR_DESPESA)), 0)
   INTO IVLR_DESPESAS_VENCIDAS
   FROM TBCONTAS_PAGAR A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.SITUACAO = 'E' AND -- NÃO PAGAS
         TRUNC(A.DATA_VENCIMENTO) >= PDATA_INICIAL AND
         TRUNC(A.DATA_VENCIMENTO) < PDATA_FINAL;

   IVLR_REAL_A_PAGAR := IVLR_DESPESAS + IVLR_DESPESAS_VENCIDAS;
   ---------------------------------------------------   

   -- CONTAS A RECEBER (ENTRADA) ---     
   -- AQUI PEGO O VALOR RECEBIDO 
   SELECT NVL(SUM(NVL(A.VALOR_REAL_RECEBIDO, A.TOTAL_PARCELA)), 0)
   INTO IVLR_RECEBIDO
   FROM TBCONTAS_RECEBER A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.SITUACAO = 'P' AND
         TRUNC(A.DATA_PAGAMENTO) >= PDATA_INICIAL AND
         TRUNC(A.DATA_PAGAMENTO) <= PDATA_FINAL;
   -- AQUI PEGO O VALOR DAS PARCELAS , MAS NAO SIGNIFICA QUE É O VALOR REAL RECEBIDO
   /*SELECT NVL(SUM(A.TOTAL_PARCELA), 0)
   INTO IVLR_A_RECEBER
   FROM TBCONTAS_RECEBER A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.SITUACAO = 'P' AND
         TRUNC(A.DATA_PAGAMENTO) >= PDATA_INICIAL AND
         TRUNC(A.DATA_PAGAMENTO) <= PDATA_FINAL;*/

   SELECT NVL(SUM(A.TOTAL_PARCELA), 0)
   INTO IVLR_A_RECEBER
   FROM TBCONTAS_RECEBER A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.SITUACAO = 'E' AND
         TRUNC(A.DATA_VENCIMENTO) >= PDATA_INICIAL AND
         TRUNC(A.DATA_VENCIMENTO) <= PDATA_FINAL;

   SELECT NVL(SUM(NVL(A.VALOR_REAL_RECEBIDO, A.TOTAL_PARCELA)), 0)
   INTO IVLR_RECEBER_VENCIDO
   FROM TBCONTAS_RECEBER A
   WHERE A.COD_EMPRESA = PCOD_EMPRESA AND
         A.SITUACAO = 'E' AND
         TRUNC(A.DATA_VENCIMENTO) >= PDATA_INICIAL AND
         TRUNC(A.DATA_VENCIMENTO) < PDATA_FINAL;

   IF IVLR_RECEBER_VENCIDO > 0 THEN
      IVLR_RECEBER_REAL := IVLR_RECEBIDO + IVLR_RECEBER_VENCIDO;
   ELSE
      IVLR_RECEBER_REAL := IVLR_A_RECEBER + IVLR_RECEBIDO + IVLR_RECEBER_VENCIDO;
   END IF;


   ---------------------------------------------------
   IVLR_LUCRO          := IVLR_RECEBIDO - IVLR_DESPESAS_PAGAS;
   IVLR_LUCRO_ESTIMADO := IVLR_RECEBER_REAL - IVLR_REAL_A_PAGAR;



   INSERT INTO TBTEMPORARIA
      (CODTERMINAL, COD_APLICACAO, TIPOREGISTRO, CHAVE, NUM1, NUM2, NUM3, NUM4, NUM5, NUM6, NUM7, NUM8)
   VALUES
      (PCOD_TERMINAL, PCOD_APLICACAO, 'F', PCOD_EMPRESA, IVLR_DESPESAS_PAGAS, IVLR_DESPESAS_VENCIDAS,
       IVLR_REAL_A_PAGAR, IVLR_RECEBIDO, IVLR_RECEBER_VENCIDO, IVLR_RECEBER_REAL, IVLR_LUCRO,
       IVLR_LUCRO_ESTIMADO);
END;
/
