CREATE OR REPLACE PROCEDURE PCGERA_TOTAIS_ORCAMENTO(PCOD_TERMINAL             VARCHAR2,
                                                    PCOD_APLICACAO            VARCHAR2,
                                                    PCOD_EMPRESA              VARCHAR2,
                                                    PPORCENTAGEM_DESCONTO     NUMBER,
                                                    PVALOR_TOTAL_SEM_DESCONTO OUT NUMBER,
                                                    PVALOR_DESCONTO           OUT NUMBER,
                                                    PVALOR_ESTIMADO           OUT NUMBER,
                                                    PVALOR_TOTAL_COM_DESCONTO OUT NUMBER) IS
   I_VALOR                   TBSERVICOS.VALOR%TYPE;
   I_VALOR_DESCONTO          NUMBER;
   IVALOR_TOTAL_SEM_DESCONTO NUMBER;
   IVALOR_DESCONTO           NUMBER;
   IVALOR_ESTIMADO           NUMBER;
   IVALOR_TOTAL_COM_DESCONTO NUMBER;
   IVALOR_ITENS_ORCAMENTO    NUMBER;
   --IVALOR_DESCONTO           
BEGIN
   IVALOR_TOTAL_SEM_DESCONTO := 0;
   IVALOR_DESCONTO           := 0;
   IVALOR_ESTIMADO           := 0;
   IVALOR_TOTAL_COM_DESCONTO := 0;
   FOR VITENS IN (SELECT *
                  FROM TBTEMPORARIA A
                  WHERE A.CODTERMINAL = PCOD_TERMINAL AND
                        A.COD_APLICACAO = PCOD_APLICACAO AND
                        A.NUM1 = PCOD_EMPRESA AND
                        A.TIPOREGISTRO = 'T')
   LOOP
   
      I_VALOR          := 0;
      I_VALOR_DESCONTO := 0;
      --IF PPORCENTAGEM_DESCONTO <> 0 THEN
         SELECT B.VALOR
         INTO I_VALOR
         FROM TBSERVICOS B
         WHERE B.COD_EMPRESA = VITENS.NUM1 AND
               B.COD_SERVICO = VITENS.NUM3;
         -- PARA FACILITAR O CALCULO DO DESCONTO EU DOU UPDATE PAR AO VALOR BASE DO PRODUTO ANTES DE DAR O DESCONTO. 
         UPDATE TBTEMPORARIA X
         SET NUM4 = I_VALOR
         WHERE X.CODTERMINAL = VITENS.CODTERMINAL AND
               X.COD_APLICACAO = VITENS.COD_APLICACAO AND
               X.NUM1 = VITENS.NUM1 AND
               X.TIPOREGISTRO = VITENS.TIPOREGISTRO AND
               X.NUM3 = VITENS.NUM3;
         --- CALCULO DO VALOR DO DESCONTO;
         SELECT TRUNC((X.NUM4 * PPORCENTAGEM_DESCONTO) / 100, 2)
         INTO I_VALOR_DESCONTO
         FROM TBTEMPORARIA X
         WHERE X.CODTERMINAL = VITENS.CODTERMINAL AND
               X.COD_APLICACAO = VITENS.COD_APLICACAO AND
               X.NUM1 = VITENS.NUM1 AND
               X.TIPOREGISTRO = VITENS.TIPOREGISTRO AND
               X.NUM3 = VITENS.NUM3;
         --- UPDATE COM O VALOR DO DESCONTO NO ITEM       
         UPDATE TBTEMPORARIA X
         SET NUM4 = NUM4 - I_VALOR_DESCONTO
         WHERE X.CODTERMINAL = VITENS.CODTERMINAL AND
               X.COD_APLICACAO = VITENS.COD_APLICACAO AND
               X.NUM1 = VITENS.NUM1 AND
               X.TIPOREGISTRO = VITENS.TIPOREGISTRO AND
               X.NUM3 = VITENS.NUM3;
      
      --END IF;
   
   END LOOP;
   -- VALOR_TOTAL_SEM_DESCONTO
   SELECT SUM(B.VALOR * X.NUM5)
   INTO IVALOR_TOTAL_SEM_DESCONTO
   FROM TBTEMPORARIA X, TBSERVICOS B
   WHERE X.CODTERMINAL = PCOD_TERMINAL AND
         X.COD_APLICACAO = PCOD_APLICACAO AND
         X.NUM1 = PCOD_EMPRESA AND
         X.TIPOREGISTRO = 'T' AND
         B.COD_EMPRESA = X.NUM1 AND
         B.COD_SERVICO = X.NUM3;
   ----------------------------------------------
   --- VALOR_DESCONTO
   SELECT (SUM(B.VALOR * X.NUM5) * PPORCENTAGEM_DESCONTO) / 100
   INTO IVALOR_DESCONTO
   FROM TBTEMPORARIA X, TBSERVICOS B
   WHERE X.CODTERMINAL = PCOD_TERMINAL AND
         X.COD_APLICACAO = PCOD_APLICACAO AND
         X.NUM1 = PCOD_EMPRESA AND
         X.TIPOREGISTRO = 'T' AND
         B.COD_EMPRESA = X.NUM1 AND
         B.COD_SERVICO = X.NUM3;
   ------------------------------------
   --- VALOR_ESTIMADO
   SELECT SUM(X.NUM4 * X.NUM5)
   INTO IVALOR_ESTIMADO
   FROM TBTEMPORARIA X
   WHERE X.CODTERMINAL = PCOD_TERMINAL AND
         X.COD_APLICACAO = PCOD_APLICACAO AND
         X.NUM1 = PCOD_EMPRESA;
   -----------------------------------------  
   -- VALOR_TOTAL_COM_DESCONTO
   SELECT SUM(X.NUM4 * X.NUM5)
   INTO IVALOR_TOTAL_COM_DESCONTO
   FROM TBTEMPORARIA X
   WHERE X.CODTERMINAL = PCOD_TERMINAL AND
         X.COD_APLICACAO = PCOD_APLICACAO AND
         X.NUM1 = PCOD_EMPRESA AND
         X.TIPOREGISTRO = 'T';
   -----------------------------------------------



   PVALOR_TOTAL_SEM_DESCONTO := TRUNC(IVALOR_TOTAL_SEM_DESCONTO, 2);
   PVALOR_DESCONTO           := TRUNC(IVALOR_DESCONTO, 2);
   PVALOR_ESTIMADO           := TRUNC(IVALOR_ESTIMADO, 2);
   PVALOR_TOTAL_COM_DESCONTO := TRUNC(IVALOR_TOTAL_COM_DESCONTO, 2);
   --COMMIT;
END;
/
