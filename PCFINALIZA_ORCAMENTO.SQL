CREATE OR REPLACE PROCEDURE PCFINALIZA_ORCAMENTO(PCOD_TERMINAL            VARCHAR2,
                                                 PCOD_APLICACAO           VARCHAR2,
                                                 PCOD_EMPRESA             NUMBER,
                                                 PCOD_CLIENTE             NUMBER,
                                                 PCOD_ORCAMENTO           NUMBER,
                                                 PDESCRICAO_ORCAMENTO     VARCHAR2,
                                                 PDATA_INICIO             DATE,
                                                 PDATA_FINAL              DATE,
                                                 PVALOR_TOTAL             NUMBER,
                                                 PVALOR_DESCONTO          NUMBER,
                                                 PVALOR_SERV_TERCEIRO     NUMBER,
                                                 PUSUA_RESPONSAVEL        VARCHAR2,
                                                 PCOD_USUARIO_RESPONSAVEL NUMBER,
                                                 PPORCENTAGEM_DESCONTO    NUMBER DEFAULT 0) IS
   IVLR_SERV_TERCEIRO  TBSERVICOS2.VALOR%TYPE;
   IQTDE_SERV_TERCEIRO NUMBER;
   ICOD_SERV_TERCEIRO  TBSERVICOS2.COD_SERVICO_TERCEIRO%TYPE;

BEGIN

   UPDATE TBHEADER_ORCAMENTO A
   SET A.DESCRICAO               = PDESCRICAO_ORCAMENTO,
       A.DATA_INICIAL_VIGENCIA   = PDATA_INICIO,
       A.DATA_FINAL_VIGENCIA     = PDATA_FINAL,
       A.VALOR_TOTAL             = PVALOR_TOTAL,
       A.VALOR_DESCONTO          = PVALOR_DESCONTO,
       A.VALOR_SERV_TERCEIRO     = PVALOR_SERV_TERCEIRO,
       A.USUA_RESPONSAVEL        = PUSUA_RESPONSAVEL,
       A.COD_USUARIO_RESPONSAVEL = PCOD_USUARIO_RESPONSAVEL,
       A.PORCENTAGEM_DESCONTO    = PPORCENTAGEM_DESCONTO
   WHERE A.COD_ORCAMENTO = PCOD_ORCAMENTO AND
         A.COD_EMPRESA = PCOD_EMPRESA AND
         A.COD_CLIENTE = PCOD_CLIENTE;
   IF SQL%NOTFOUND THEN
      INSERT INTO TBHEADER_ORCAMENTO
         (COD_ORCAMENTO, COD_EMPRESA, COD_CLIENTE, DESCRICAO, SITUACAO, DATA_INICIAL_VIGENCIA,
          DATA_FINAL_VIGENCIA, VALOR_TOTAL, VALOR_DESCONTO, DATA_CADASTRO, VALOR_SERV_TERCEIRO,
          USUA_RESPONSAVEL, COD_USUARIO_RESPONSAVEL, PORCENTAGEM_DESCONTO)
      VALUES
         (PCOD_ORCAMENTO, PCOD_EMPRESA, PCOD_CLIENTE, PDESCRICAO_ORCAMENTO, 'A', PDATA_INICIO,
          TO_DATE(PDATA_FINAL), PVALOR_TOTAL, PVALOR_DESCONTO, TRUNC(SYSDATE), PVALOR_SERV_TERCEIRO,
          PUSUA_RESPONSAVEL, PCOD_USUARIO_RESPONSAVEL, PPORCENTAGEM_DESCONTO);
   END IF;

   DELETE FROM TBITENS_ORCAMENTO
   WHERE COD_ORCAMENTO = PCOD_ORCAMENTO AND
         COD_EMPRESA = PCOD_EMPRESA AND
         COD_CLIENTE = PCOD_CLIENTE;

   FOR VITENS IN (SELECT *
                  FROM TBTEMPORARIA A
                  WHERE A.CODTERMINAL = PCOD_TERMINAL AND
                        A.COD_APLICACAO = PCOD_APLICACAO AND
                        A.NUM1 = PCOD_EMPRESA AND
                        A.TIPOREGISTRO = 'T')
   LOOP
      --/// deleto da Itens para inserir somente os itens que estavam na tela do cara
   
      UPDATE TBITENS_ORCAMENTO B
      SET B.VALOR_SERV_INDIVIDUAL = VITENS.NUM4,
          B.QUANTIDADE_SERVICO    = VITENS.NUM5,
          B.TEM_SERV_TERCEIRO     = VITENS.ALFA1
      WHERE B.COD_SERVICO = VITENS.NUM3 AND
            B.COD_ORCAMENTO = PCOD_ORCAMENTO AND
            B.COD_EMPRESA = PCOD_EMPRESA AND
            B.COD_CLIENTE = PCOD_CLIENTE;
      IF SQL%NOTFOUND THEN
         INSERT INTO TBITENS_ORCAMENTO
            (COD_SERVICO, COD_ORCAMENTO, COD_EMPRESA, COD_CLIENTE, VALOR_SERV_INDIVIDUAL, QUANTIDADE_SERVICO,
             TEM_SERV_TERCEIRO)
         VALUES
            (VITENS.NUM3, PCOD_ORCAMENTO, PCOD_EMPRESA, PCOD_CLIENTE, VITENS.NUM4, VITENS.NUM5, VITENS.ALFA1);
      END IF;
      IF VITENS.ALFA1 = 'S' THEN
         SELECT A.NUM3, A.NUM5, A.NUM4
         INTO ICOD_SERV_TERCEIRO, IQTDE_SERV_TERCEIRO, IVLR_SERV_TERCEIRO
         FROM TBTEMPORARIA A
         WHERE A.CODTERMINAL = PCOD_TERMINAL AND
               A.COD_APLICACAO = PCOD_APLICACAO AND
               A.NUM1 = PCOD_EMPRESA AND
               A.TIPOREGISTRO = 'S' AND
               A.NUM2 = VITENS.NUM3;
      
         UPDATE TBITENS_ORCAMENTO
         SET COD_SERVICO_TERCEIRO = ICOD_SERV_TERCEIRO,
             VALOR_SERV_TERCEIRO  = IVLR_SERV_TERCEIRO,
             QTDE_SERV_TERCEIRO   = IQTDE_SERV_TERCEIRO
         WHERE COD_SERVICO = VITENS.NUM3 AND
               COD_ORCAMENTO = PCOD_ORCAMENTO AND
               COD_EMPRESA = PCOD_EMPRESA AND
               COD_CLIENTE = PCOD_CLIENTE;
      
      END IF;
   END LOOP;

   -- ITENS DE TERCEIRO INSERIDOS INDIVIDUALMENTE
   FOR VITENS_TERC IN (SELECT *
                       FROM TBTEMPORARIA A
                       WHERE A.CODTERMINAL = PCOD_TERMINAL AND
                             A.COD_APLICACAO = PCOD_APLICACAO AND
                             A.NUM1 = PCOD_EMPRESA AND
                             A.TIPOREGISTRO = 'S' AND
                             A.ALFA2 = 'P' AND 
                             A.ALFA4 = 'I') -- AQUI QUANDO TIVER 'I' É QUE FOI INSERIDO INDIVIDULA
   LOOP
      UPDATE TBITENS_ORCAMENTO_TERCEIRO B
      SET B.VALOR = VITENS_TERC.NUM4,
          B.QUANTIDADE_SERVICO    = VITENS_TERC.NUM5  
      WHERE B.COD_SERVICO_TERC = VITENS_TERC.NUM3 AND
            B.COD_ORCAMENTO = PCOD_ORCAMENTO AND
            B.COD_EMPRESA = PCOD_EMPRESA AND
            B.COD_CLIENTE = PCOD_CLIENTE;
      IF SQL%NOTFOUND THEN
         INSERT INTO TBITENS_ORCAMENTO_TERCEIRO
            (COD_SERVICO_TERC, COD_ORCAMENTO, COD_EMPRESA, COD_CLIENTE, VALOR,
             QUANTIDADE_SERVICO)
         VALUES
            (VITENS_TERC.NUM3, PCOD_ORCAMENTO, PCOD_EMPRESA, PCOD_CLIENTE, VITENS_TERC.NUM4, VITENS_TERC.NUM5);
      END IF;
   END LOOP;
END;
/
